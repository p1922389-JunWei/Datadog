services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: datadog-agent
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=ap2.datadoghq.com
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_CONTAINER_EXCLUDE="name:datadog-agent"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - dd-agent-logs:/opt/datadog-agent/run:rw
    ports:
      - "8126:8126"

  api:
    build: .
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DD_AGENT_HOST=datadog-agent # Connects to datadog agent (in another container)
      - DD_TRACE_AGENT_URL=http://datadog-agent:8126

      # Tags for filtering
      - DD_SERVICE=${DD_SERVICE:-gemini-chat-api}
      - DD_VERSION=${DD_VERSION:-1.0.0}
      - DD_ENV=${DD_ENV:-development}

      # LLM Observability tags (this will auto monitor gemini and report metrics to DD)
      - DD_LLMOBS_ENABLED=1
      - DD_LLMOBS_ML_APP=gemini-chat-api
      - DD_LLMOBS_AGENTLESS_ENABLED=0
      
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  traffic:
    build: .
    command: python traffic.py
    env_file:
      - .env
    environment:
      - API_HOST=api
    depends_on:
      - api
    restart: "no"  # Run once and stop

volumes:
  dd-agent-logs:
